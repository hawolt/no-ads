# =============================================================================
# Build & Release Pipeline
# =============================================================================
#
# This workflow handles CI/CD:
#
# TRIGGERS:
#   - Push to main: Builds artifacts and creates a GitHub release
#   - Pull requests: Runs tests only (no build/release)
#
# JOBS:
#   1. test          - Runs Maven tests on PRs to validate changes
#   2. build-windows - Builds Windows executable with embedded JRE via Rust wrapper
#   3. build-macos   - Builds JAR for macOS/Linux
#   4. build-extension - Packages the Chromium browser extension
#   5. release       - Creates GitHub release with all artifacts
#
# ARTIFACTS PRODUCED:
#   - local-server.exe     (Windows - self-contained with JRE)
#   - local-server.jar     (macOS/Linux - requires Java 17)
#   - chromium-extension.zip (Browser extension)
#
# =============================================================================

name: Build & Release

on:
  push:
    branches:
      - main
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: write

jobs:
  # Run tests on PRs only
  test:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Cache Maven dependencies
        uses: actions/cache@v3
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2

      - name: Run tests
        run: cd local-server && mvn test

  # Build and release on pushes to main
  build-windows:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Cache Maven dependencies
        uses: actions/cache@v3
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2

      - name: Build local-server with Maven
        run: make build
        shell: bash

      - name: Download JRE
        shell: powershell
        run: |
          Write-Host "Downloading JRE 17.0.17..."
          Invoke-WebRequest -Uri "https://github.com/adoptium/temurin17-binaries/releases/download/jdk-17.0.17+10/OpenJDK17U-jdk_x64_windows_hotspot_17.0.17_10.zip" -OutFile "jre-17.0.17-x64.zip"
          Write-Host "JRE download completed"

      - name: Set up Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          default: true
          override: true

      - name: Prepare files for Rust build
        shell: bash
        run: |
          cp local-server/target/application.jar rust-wrapper/application.jar
          cp jre-17.0.17-x64.zip rust-wrapper/jre.zip
          echo "Files prepared for Rust build"

      - name: Build Rust wrapper
        uses: actions-rs/cargo@v1
        with:
          command: build
          args: --release --manifest-path rust-wrapper/Cargo.toml

      - name: Rename Rust executable
        shell: bash
        run: |
          mv rust-wrapper/target/release/rust-wrapper.exe rust-wrapper/target/release/local-server.exe || \
          mv rust-wrapper/target/release/*.exe rust-wrapper/target/release/local-server.exe
          echo "Rust executable renamed to local-server.exe"

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: local-server-windows
          path: rust-wrapper/target/release/local-server.exe

  build-macos:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Cache Maven dependencies
        uses: actions/cache@v3
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2

      - name: Build local-server with Maven
        run: make build

      - name: Rename JAR for release
        run: cp local-server/target/application.jar local-server/target/local-server.jar

      - name: Upload macOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: local-server-macos
          path: local-server/target/local-server.jar

  build-extension:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Package Chrome extension
        run: make package-extension

      - name: Upload extension artifact
        uses: actions/upload-artifact@v4
        with:
          name: chromium-extension
          path: chromium-extension.zip

  release:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: [build-windows, build-macos, build-extension]
    runs-on: ubuntu-latest

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display structure of downloaded files
        run: ls -R artifacts

      - name: Create GitHub Release
        id: create_release
        uses: actions/create-release@v1
        with:
          tag_name: "release-${{ github.sha }}"
          release_name: "Release ${{ github.sha }}"
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload local-server.exe (Windows)
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: artifacts/local-server-windows/local-server.exe
          asset_name: local-server.exe
          asset_content_type: application/octet-stream
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload local-server.jar (macOS/Linux)
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: artifacts/local-server-macos/local-server.jar
          asset_name: local-server.jar
          asset_content_type: application/java-archive
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload chromium-extension.zip
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: artifacts/chromium-extension/chromium-extension.zip
          asset_name: chromium-extension.zip
          asset_content_type: application/zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate workflow summary
        run: |
          echo "## Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Release Tag:** \`release-${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Artifacts Published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Platform | Artifact | Description |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|----------|-------------|" >> $GITHUB_STEP_SUMMARY
          echo "| Windows | \`local-server.exe\` | Self-contained executable with embedded JRE |" >> $GITHUB_STEP_SUMMARY
          echo "| macOS/Linux | \`local-server.jar\` | Java archive (requires JDK 17) |" >> $GITHUB_STEP_SUMMARY
          echo "| Browser | \`chromium-extension.zip\` | Chromium browser extension |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** [\`${{ github.sha }}\`](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})" >> $GITHUB_STEP_SUMMARY
