name: Build Pipeline

on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Cache Maven dependencies
        uses: actions/cache@v3
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2

      - name: Build local-server with Maven
        shell: powershell
        run: |
          cd local-server
          mvn clean package -DskipTests
          Write-Host "Maven build completed"
          Get-ChildItem -Path target -Force

      - name: Verify application.jar exists
        shell: powershell
        run: |
          if (Test-Path "local-server/target/application.jar") {
              Write-Host "application.jar found"
              Get-ChildItem -Path local-server/target/application.jar -Force
          } else {
              Write-Host "Looking for JAR files in target directory..."
              $JAR_FILE = Get-ChildItem -Path local-server/target -Filter "*.jar" -Recurse |
                          Where-Object { $_.Name -notmatch "sources|javadoc" } |
                          Select-Object -First 1
              if ($JAR_FILE) {
                  Copy-Item $JAR_FILE.FullName "local-server/target/application.jar"
                  Write-Host "Renamed to application.jar"
              } else {
                  Write-Error "No suitable JAR file found"
                  exit 1
              }
          }

      - name: Download JRE
        shell: powershell
        run: |
          Write-Host "Downloading JRE 17.0.17 from Red Hat..."
          Invoke-WebRequest -Uri "https://github.com/adoptium/temurin17-binaries/releases/download/jdk-17.0.17+10/OpenJDK17U-jdk_x64_windows_hotspot_17.0.17_10.zip" -OutFile "jre-17.0.17-x64.zip"
          Write-Host "JRE download completed"
          Get-ChildItem -Path jre-17.0.17-x64.zip -Force

      - name: Set up Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          default: true
          override: true

      - name: Cache Rust dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            rust-wrapper/target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: ${{ runner.os }}-cargo-

      - name: Prepare files for Rust build
        shell: powershell
        run: |
          Write-Host "Preparing files for Rust wrapper..."
          Copy-Item "local-server/target/application.jar" "rust-wrapper/application.jar"
          Copy-Item "jre-17.0.17-x64.zip" "rust-wrapper/jre.zip"
          Write-Host "Files prepared for Rust build:"
          Get-ChildItem -Path "rust-wrapper/application.jar", "rust-wrapper/jre.zip" -Force

      - name: Build Rust wrapper
        uses: actions-rs/cargo@v1
        with:
          command: build
          args: --release --manifest-path rust-wrapper/Cargo.toml

      - name: Verify Rust build output
        shell: powershell
        run: |
          Write-Host "Rust build completed. Checking output:"
          Get-ChildItem -Path "rust-wrapper/target/release" -Force
          $exe = Get-ChildItem -Path "rust-wrapper/target/release" -Filter "*.exe" | Select-Object -First 1
          Write-Host "Found executable: $($exe.FullName)"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            local-server/target/application.jar
            jre-17.0.17-x64.zip
            rust-wrapper/target/release/*.exe
          retention-days: 30

      - name: Create release assets (on main branch)
        if: github.ref == 'refs/heads/main'
        shell: powershell
        run: |
          New-Item -ItemType Directory -Force -Path release-assets
          Copy-Item "local-server/target/application.jar" "release-assets/"
          Copy-Item "jre-17.0.17-x64.zip" "release-assets/jre.zip"
          $exe = Get-ChildItem -Path "rust-wrapper/target/release" -Filter "*.exe" | Select-Object -First 1
          Copy-Item $exe.FullName "release-assets/"
          Write-Host "Release assets prepared:"
          Get-ChildItem -Path release-assets -Force

      - name: Upload release assets
        if: github.ref == 'refs/heads/main'
        uses: actions/upload-artifact@v4
        with:
          name: release-assets
          path: release-assets/
          retention-days: 90
